#!/usr/bin/env node

/**
 * Deps.
 */

var fs = require('fs');
var csv = require('csv');
var redis = require('redis');
var pkg = require('../package');
var program = require('commander');

/**
 * Options.
 */

program
  .version(pkg.version)
  .option('-p --port [port]', 'redis port', 6379)
  .option('-h, --host [host]', 'redis host', 'localhost')
  .option('-f, --file <file>', 'maxmind csv file')
  .option('-n, --namespace [namespace]', 'namespace in redis', 'geo')
  .parse(process.argv);

/**
 * Redis connection.
 */

var rc = redis.createClient();
var prefix = program.namespace + ':' + 'location';

/**
 * Process.
 */

csv()
.from.stream(fs.createReadStream(program.file))
.on('record', function (row, index) {
  var id = parseInt(row[0], 10);
  var key = prefix + ':' + id;

  if (isNaN(id)) return;

  rc.hmset(key, {
    country: row[1],
    state: row[2],
    city: row[3],
    zip: row[4],
    lat: row[5],
    lng: row[6],
    metro: row[7],
    areacode: row[8]
  });
});
