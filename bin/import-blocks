#!/usr/bin/env node

/**
 * Deps.
 */

var fs = require('fs');
var csv = require('csv');
var redis = require('redis');
var pkg = require('../package');
var program = require('commander');

/**
 * Options.
 */

program
  .version(pkg.version)
  .option('-p --port [port]', 'redis port', 6379)
  .option('-h, --host [host]', 'redis host', 'localhost')
  .option('-f, --file <file>', 'maxmind csv file')
  .option('-n, --namespace [namespace]', 'namespace in redis', 'geo')
  .parse(process.argv);

/**
 * Redis connection.
 */

var rc = redis.createClient();
var ipcity = program.namespace + ':' + 'blocks';

/**
 * Process.
 */

csv()
.from.stream(fs.createReadStream(program.file))
.on('record', function (row, index) {
  var start = parseInt(row[0], 10);
  var city = parseInt(row[2], 10);

  if (isNaN(start)) return;
  if (isNaN(city)) return;

  city = city + '_' + index;
  rc.zadd(ipcity, start, city);
});
